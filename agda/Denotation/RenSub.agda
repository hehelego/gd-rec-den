open import Agda.Builtin.Cubical.Path
open import Cubical.Foundations.Prelude hiding (Type; _,_; cong; congâ‚‚; congâ‚ƒ) renaming (_âˆ™_ to trans)


open import LaterPrims
open import Helper
open import Term
open import Renaming
open import Substitution
open import Denotation.LaterAlgebra
open import Denotation.Interpretation

-- The denotation of an expression after substitution/renaming under an interpretation of a context
-- is equivalent to
-- the denotation of the expression computed under the substituted/renamed interpretation of the context
module Denotation.RenSub where

infixl 9 _á¶œâŸª_âŸ«
infixl 9 _á¶œâŸª_âŸ«Ë¢
infix 10 _á¶œâŸª_âŸ«âŸ¨_âŸ©áµ‰
infix 10 _á¶œâŸª_âŸ«Ë¢âŸ¨_âŸ©áµ‰
infix 10 rename-âŸ¦_âŸ§
infix 10 subst-âŸ¦_âŸ§

-- interaction between Renaming _âŸª_âŸ« and denotation interpretation âŸ¦_âŸ§.

_á¶œâŸª_âŸ« : Renaming Î“ Î” â†’ âŸ¦ Î” âŸ§c â†’ âŸ¦ Î“ âŸ§c
âˆ… á¶œâŸª Î³ âŸ« = âˆ…
(x âˆ· Ï) á¶œâŸª Î³ âŸ« = Î³ âŸ¨ x âŸ©áµ‰ âˆ· Ï á¶œâŸª Î³ âŸ«

_á¶œâŸª_âŸ«âŸ¨_âŸ©áµ‰ : (Ï : Renaming Î“ Î”) (Î³ : âŸ¦ Î” âŸ§c) (n : Î“ âˆ‹ Ï„)
          â†’ Ï á¶œâŸª Î³ âŸ« âŸ¨ n âŸ©áµ‰ â‰¡ Î³ âŸ¨ Ï âŸ¨ n âŸ© âŸ©áµ‰
(x âˆ· Ï) á¶œâŸª Î³ âŸ«âŸ¨ Z âŸ©áµ‰ =
    (x âˆ· Ï) á¶œâŸª Î³ âŸ« âŸ¨ Z âŸ©áµ‰
        â‰¡âŸ¨âŸ©
    (Î³ âŸ¨ x âŸ©áµ‰ âˆ· Ï á¶œâŸª Î³ âŸ«) âŸ¨ Z âŸ©áµ‰
        â‰¡âŸ¨âŸ©
    Î³ âŸ¨ x âŸ©áµ‰
        â‰¡âŸ¨âŸ©
    Î³ âŸ¨ (x âˆ· Ï) âŸ¨ Z âŸ© âŸ©áµ‰ âˆ
(x âˆ· Ï) á¶œâŸª Î³ âŸ«âŸ¨ S n âŸ©áµ‰ =
    (x âˆ· Ï) á¶œâŸª Î³ âŸ« âŸ¨ S n âŸ©áµ‰
        â‰¡âŸ¨âŸ©
    (Î³ âŸ¨ x âŸ©áµ‰ âˆ· Ï á¶œâŸª Î³ âŸ«) âŸ¨ S n âŸ©áµ‰
        â‰¡âŸ¨âŸ©
    Ï á¶œâŸª Î³ âŸ« âŸ¨ n âŸ©áµ‰
        â‰¡âŸ¨ Ï á¶œâŸª Î³ âŸ«âŸ¨ n âŸ©áµ‰ âŸ©
    Î³ âŸ¨ Ï âŸ¨ n âŸ© âŸ©áµ‰
        â‰¡âŸ¨âŸ©
    Î³ âŸ¨ (x âˆ· Ï) âŸ¨ S n âŸ© âŸ©áµ‰ âˆ


suc-renaming-á¶œâŸª-âˆ·-âŸ« : (Ï : Renaming Î“ Î”) (Î³ : âŸ¦ Î” âŸ§c) (Î± : âŸ¦ Ï„ âŸ§t)
                    â†’ Ï á¶œâŸª Î³ âŸ« â‰¡ suc-renaming Ï á¶œâŸª Î± âˆ· Î³ âŸ«
suc-renaming-á¶œâŸª-âˆ·-âŸ« âˆ… Î³ Î± = refl
suc-renaming-á¶œâŸª-âˆ·-âŸ« (x âˆ· Ï) Î³ Î± = cong (Î³ âŸ¨ x âŸ©áµ‰ âˆ·_) (suc-renaming-á¶œâŸª-âˆ·-âŸ« Ï Î³ Î±)

ext-á¶œâŸª-âˆ·-âŸ« : (Ï : Renaming Î“ Î”) (Î³ : âŸ¦ Î” âŸ§c) (Î± : âŸ¦ Ï„ âŸ§t) â†’ Î± âˆ· (Ï á¶œâŸª Î³ âŸ«) â‰¡ ext Ï á¶œâŸª Î± âˆ· Î³ âŸ«
ext-á¶œâŸª-âˆ·-âŸ« Ï Î³ Î± = cong (Î± âˆ·_) (suc-renaming-á¶œâŸª-âˆ·-âŸ« Ï Î³ Î±)

rename-idá¶œâŸª_âŸ« : (Î³ : âŸ¦ Î“ âŸ§c) â†’ idá´¿ Î“ á¶œâŸª Î³ âŸ« â‰¡ Î³
rename-idá¶œâŸª âˆ… âŸ« = refl
rename-idá¶œâŸª Î± âˆ· Î³ âŸ« =
    idá´¿ _ á¶œâŸª Î± âˆ· Î³ âŸ«
        â‰¡âŸ¨âŸ©
    (Z âˆ· suc-renaming (idá´¿ _)) á¶œâŸª Î± âˆ· Î³ âŸ«
        â‰¡âŸ¨âŸ©
    (Î± âˆ· Î³) âŸ¨ Z âŸ©áµ‰ âˆ· suc-renaming (idá´¿ _) á¶œâŸª Î± âˆ· Î³ âŸ«
        â‰¡âŸ¨âŸ©
    Î± âˆ· suc-renaming (idá´¿ _) á¶œâŸª Î± âˆ· Î³ âŸ«
        â‰¡âŸ¨ cong (Î± âˆ·_) (sym (suc-renaming-á¶œâŸª-âˆ·-âŸ« (idá´¿ _) Î³ Î±)) âŸ©
    Î± âˆ· idá´¿ _ á¶œâŸª Î³ âŸ«
        â‰¡âŸ¨ cong (Î± âˆ·_) rename-idá¶œâŸª Î³ âŸ« âŸ©
    Î± âˆ· Î³ âˆ


rename-âŸ¦_âŸ§ :  (e : Î“ âŠ¢ Ï„) (Ï : Renaming Î“ Î”) (Î³ : âŸ¦ Î” âŸ§c)
           â†’ âŸ¦ e âŸ§ (Ï á¶œâŸª Î³ âŸ«) â‰¡ âŸ¦ Ï âŸª e âŸ« âŸ§ Î³
rename-âŸ¦ var n âŸ§ Ï Î³ = Ï á¶œâŸª Î³ âŸ«âŸ¨ n âŸ©áµ‰
rename-âŸ¦ f âˆ™ t âŸ§ Ï Î³  = congâ‚‚ (Î» [f] [t] â†’ [f] [t]) (rename-âŸ¦ f âŸ§ Ï Î³) (rename-âŸ¦ t âŸ§ Ï Î³)
rename-âŸ¦ abs e âŸ§ Ï Î³ = funExt (Î» Î± â†’
        âŸ¦ abs e âŸ§ (Ï á¶œâŸª Î³ âŸ«) Î±
            â‰¡âŸ¨âŸ©
        âŸ¦ e âŸ§ (Î± âˆ· Ï á¶œâŸª Î³ âŸ«)
            â‰¡âŸ¨ cong âŸ¦ e âŸ§ (ext-á¶œâŸª-âˆ·-âŸ« Ï Î³ Î±) âŸ©
        âŸ¦ e âŸ§ (ext Ï á¶œâŸª Î± âˆ· Î³ âŸ«)
            â‰¡âŸ¨ rename-âŸ¦ e âŸ§ (ext Ï) (Î± âˆ· Î³) âŸ©
        âŸ¦ ext Ï âŸª e âŸ« âŸ§ (Î± âˆ· Î³)
            â‰¡âŸ¨âŸ©
        âŸ¦ Ï âŸª abs e âŸ« âŸ§ Î³ Î± âˆ)
rename-âŸ¦ # n âŸ§ Ï Î³ = refl
rename-âŸ¦ pred e âŸ§ Ï Î³ = cong (ğ“›-map nat-pred) (rename-âŸ¦ e âŸ§ Ï Î³)
rename-âŸ¦ succ e âŸ§ Ï Î³ = cong (ğ“›-map nat-succ) (rename-âŸ¦ e âŸ§ Ï Î³)
rename-âŸ¦ ifz e then tâ‚€ else tâ‚ âŸ§ Ï Î³ = congâ‚ƒ (Î» [e] [0] [1] â†’ map-ext â–¹alg' (nat-ifz [0] [1]) [e])
                                             (rename-âŸ¦ e âŸ§ Ï Î³) (rename-âŸ¦ tâ‚€ âŸ§ Ï Î³) (rename-âŸ¦ tâ‚ âŸ§ Ï Î³)
rename-âŸ¦ Y f âŸ§ Ï Î³ = cong (Î» [f] â†’ gfix (Î» x â†’ Î¸' (next [f] âŠ› x))) (rename-âŸ¦ f âŸ§ Ï Î³)

suc-rename-idá´¿âŸ¦_âŸ§ : (t : Î“ âŠ¢ Ï„) (Î³ : âŸ¦ Î“ âŸ§c) (Î± : âŸ¦ Ï„â‚ âŸ§t) â†’ âŸ¦ suc-renaming (idá´¿ _) âŸª t âŸ« âŸ§ (Î± âˆ· Î³) â‰¡ âŸ¦ t âŸ§ Î³
suc-rename-idá´¿âŸ¦ t âŸ§ Î³ Î± = sym (
    âŸ¦ t âŸ§ Î³
        â‰¡âŸ¨ cong âŸ¦ t âŸ§ (sym rename-idá¶œâŸª Î³ âŸ«) âŸ©
    âŸ¦ t âŸ§ (idá´¿ _ á¶œâŸª Î³ âŸ«)
        â‰¡âŸ¨ cong âŸ¦ t âŸ§ (suc-renaming-á¶œâŸª-âˆ·-âŸ« (idá´¿ _) Î³ Î±) âŸ©
    âŸ¦ t âŸ§ (suc-renaming (idá´¿ _) á¶œâŸª Î± âˆ· Î³ âŸ«)
        â‰¡âŸ¨ rename-âŸ¦ t âŸ§ (suc-renaming (idá´¿ _)) (Î± âˆ· Î³) âŸ©
    âŸ¦ suc-renaming (idá´¿ _) âŸª t âŸ« âŸ§ (Î± âˆ· Î³) âˆ)


-- interaction between Substitution _âŸª_âŸ«Ë¢ and denotation interpretation âŸ¦_âŸ§.

_á¶œâŸª_âŸ«Ë¢ : Subst Î“ Î” â†’ âŸ¦ Î” âŸ§c â†’ âŸ¦ Î“ âŸ§c
âˆ… á¶œâŸª Î³ âŸ«Ë¢ = âˆ…
(t âˆ· Ïƒ) á¶œâŸª Î³ âŸ«Ë¢ = âŸ¦ t âŸ§ Î³ âˆ· Ïƒ á¶œâŸª Î³ âŸ«Ë¢

_á¶œâŸª_âŸ«Ë¢âŸ¨_âŸ©áµ‰ : (Ïƒ : Subst Î“ Î”) (Î³ : âŸ¦ Î” âŸ§c) (n : Î“ âˆ‹ Ï„)
           â†’ Ïƒ á¶œâŸª Î³ âŸ«Ë¢ âŸ¨ n âŸ©áµ‰ â‰¡ âŸ¦ Ïƒ âŸ¨ n âŸ©Ë¢ âŸ§ Î³
(t âˆ· Ïƒ) á¶œâŸª Î³ âŸ«Ë¢âŸ¨ Z âŸ©áµ‰ =
    (t âˆ· Ïƒ) á¶œâŸª Î³ âŸ«Ë¢ âŸ¨ Z âŸ©áµ‰
        â‰¡âŸ¨âŸ©
    (âŸ¦ t âŸ§ Î³ âˆ· Ïƒ á¶œâŸª Î³ âŸ«Ë¢) âŸ¨ Z âŸ©áµ‰
        â‰¡âŸ¨âŸ©
    âŸ¦ t âŸ§ Î³
        â‰¡âŸ¨âŸ©
    âŸ¦ (t âˆ· Ïƒ) âŸ¨ Z âŸ©Ë¢ âŸ§ Î³ âˆ
(t âˆ· Ïƒ) á¶œâŸª Î³ âŸ«Ë¢âŸ¨ S n âŸ©áµ‰ =
    (t âˆ· Ïƒ) á¶œâŸª Î³ âŸ«Ë¢ âŸ¨ S n âŸ©áµ‰
        â‰¡âŸ¨âŸ©
    (âŸ¦ t âŸ§ Î³ âˆ· Ïƒ á¶œâŸª Î³ âŸ«Ë¢) âŸ¨ S n âŸ©áµ‰
        â‰¡âŸ¨âŸ©
    Ïƒ á¶œâŸª Î³ âŸ«Ë¢ âŸ¨ n âŸ©áµ‰
        â‰¡âŸ¨ Ïƒ á¶œâŸª Î³ âŸ«Ë¢âŸ¨ n âŸ©áµ‰ âŸ©
    âŸ¦ Ïƒ âŸ¨ n âŸ©Ë¢ âŸ§ Î³
        â‰¡âŸ¨âŸ©
    âŸ¦ (t âˆ· Ïƒ) âŸ¨ S n âŸ©Ë¢ âŸ§ Î³ âˆ



suc-subst-á¶œâŸª-âˆ·-âŸ«Ë¢ : (Ïƒ : Subst Î“ Î”) (Î³ : âŸ¦ Î” âŸ§c) (Î± : âŸ¦ Ï„ âŸ§t)
                 â†’ Ïƒ á¶œâŸª Î³ âŸ«Ë¢ â‰¡ suc-subst Ïƒ á¶œâŸª Î± âˆ· Î³ âŸ«Ë¢
suc-subst-á¶œâŸª-âˆ·-âŸ«Ë¢ âˆ… Î³ Î± = refl
suc-subst-á¶œâŸª-âˆ·-âŸ«Ë¢ (t âˆ· Ïƒ) Î³ Î± =
    (t âˆ· Ïƒ) á¶œâŸª Î³ âŸ«Ë¢
        â‰¡âŸ¨âŸ©
    âŸ¦ t âŸ§ Î³ âˆ· Ïƒ á¶œâŸª Î³ âŸ«Ë¢
        â‰¡âŸ¨ cong (_âˆ· Ïƒ á¶œâŸª Î³ âŸ«Ë¢) (sym (suc-rename-idá´¿âŸ¦ t âŸ§ Î³ Î±)) âŸ©
    âŸ¦ suc-renaming (idá´¿ _) âŸª t âŸ« âŸ§ (Î± âˆ· Î³) âˆ· Ïƒ á¶œâŸª Î³ âŸ«Ë¢
        â‰¡âŸ¨ cong (âŸ¦ suc-renaming (idá´¿ _) âŸª t âŸ« âŸ§ (Î± âˆ· Î³) âˆ·_) (suc-subst-á¶œâŸª-âˆ·-âŸ«Ë¢ Ïƒ Î³ Î±) âŸ©
    âŸ¦ suc-renaming (idá´¿ _) âŸª t âŸ« âŸ§ (Î± âˆ· Î³) âˆ· suc-subst Ïƒ á¶œâŸª Î± âˆ· Î³ âŸ«Ë¢
        â‰¡âŸ¨âŸ©
    (suc-renaming (idá´¿ _) âŸª t âŸ« âˆ· suc-subst Ïƒ) á¶œâŸª Î± âˆ· Î³ âŸ«Ë¢
        â‰¡âŸ¨âŸ©
    suc-subst (t âˆ· Ïƒ) á¶œâŸª Î± âˆ· Î³ âŸ«Ë¢ âˆ

exts-á¶œâŸª-âˆ·-âŸ«Ë¢ : (Ïƒ : Subst Î“ Î”) (Î³ : âŸ¦ Î” âŸ§c) (Î± : âŸ¦ Ï„ âŸ§t) â†’ Î± âˆ· (Ïƒ á¶œâŸª Î³ âŸ«Ë¢) â‰¡ exts Ïƒ á¶œâŸª Î± âˆ· Î³ âŸ«Ë¢
exts-á¶œâŸª-âˆ·-âŸ«Ë¢ Ïƒ Î³ Î± = cong (Î± âˆ·_) (suc-subst-á¶œâŸª-âˆ·-âŸ«Ë¢ Ïƒ Î³ Î±)

subst-âŸ¦_âŸ§ :  (e : Î“ âŠ¢ Ï„) (Ïƒ : Subst Î“ Î”) (Î³ : âŸ¦ Î” âŸ§c)
          â†’ âŸ¦ e âŸ§ (Ïƒ á¶œâŸª Î³ âŸ«Ë¢) â‰¡ âŸ¦ Ïƒ âŸª e âŸ«Ë¢ âŸ§ Î³
subst-âŸ¦ var n âŸ§ Ïƒ Î³ = Ïƒ á¶œâŸª Î³ âŸ«Ë¢âŸ¨ n âŸ©áµ‰
subst-âŸ¦ f âˆ™ t âŸ§ Ïƒ Î³  = congâ‚‚ (Î» [f] [t] â†’ [f] [t]) (subst-âŸ¦ f âŸ§ Ïƒ Î³) (subst-âŸ¦ t âŸ§ Ïƒ Î³)
subst-âŸ¦ abs e âŸ§ Ïƒ Î³ = funExt (Î» Î± â†’
        âŸ¦ abs e âŸ§ (Ïƒ á¶œâŸª Î³ âŸ«Ë¢) Î±
            â‰¡âŸ¨âŸ©
        âŸ¦ e âŸ§ (Î± âˆ· Ïƒ á¶œâŸª Î³ âŸ«Ë¢)
            â‰¡âŸ¨ cong âŸ¦ e âŸ§ (exts-á¶œâŸª-âˆ·-âŸ«Ë¢ Ïƒ Î³ Î±) âŸ©
        âŸ¦ e âŸ§ (exts Ïƒ á¶œâŸª Î± âˆ· Î³ âŸ«Ë¢)
            â‰¡âŸ¨ subst-âŸ¦ e âŸ§ (exts Ïƒ) (Î± âˆ· Î³) âŸ©
        âŸ¦ exts Ïƒ âŸª e âŸ«Ë¢ âŸ§ (Î± âˆ· Î³)
            â‰¡âŸ¨âŸ©
        âŸ¦ Ïƒ âŸª abs e âŸ«Ë¢ âŸ§ Î³ Î± âˆ)
subst-âŸ¦ # n âŸ§ Ïƒ Î³ = refl
subst-âŸ¦ pred e âŸ§ Ïƒ Î³ = cong (ğ“›-map nat-pred) (subst-âŸ¦ e âŸ§ Ïƒ Î³)
subst-âŸ¦ succ e âŸ§ Ïƒ Î³ = cong (ğ“›-map nat-succ) (subst-âŸ¦ e âŸ§ Ïƒ Î³)
subst-âŸ¦ ifz e then tâ‚€ else tâ‚ âŸ§ Ïƒ Î³ = congâ‚ƒ (Î» [e] [0] [1] â†’ map-ext â–¹alg' (nat-ifz [0] [1]) [e])
                                             (subst-âŸ¦ e âŸ§ Ïƒ Î³) (subst-âŸ¦ tâ‚€ âŸ§ Ïƒ Î³) (subst-âŸ¦ tâ‚ âŸ§ Ïƒ Î³)
subst-âŸ¦ Y f âŸ§ Ïƒ Î³ = cong (Î» [f] â†’ gfix (Î» x â†’ Î¸' (next [f] âŠ› x))) (subst-âŸ¦ f âŸ§ Ïƒ Î³)


subst-idá¶œâŸª_âŸ«Ë¢ : (Î³ : âŸ¦ Î“ âŸ§c) â†’ idË¢ Î“ á¶œâŸª Î³ âŸ«Ë¢ â‰¡ Î³
subst-idá¶œâŸª âˆ… âŸ«Ë¢ = refl
subst-idá¶œâŸª Î± âˆ· Î³ âŸ«Ë¢ =
    idË¢ _ á¶œâŸª Î± âˆ· Î³ âŸ«Ë¢
        â‰¡âŸ¨âŸ©
    exts (idË¢ _) á¶œâŸª Î± âˆ· Î³ âŸ«Ë¢
        â‰¡âŸ¨ sym (exts-á¶œâŸª-âˆ·-âŸ«Ë¢ (idË¢ _) Î³ Î±) âŸ©
    Î± âˆ· (idË¢ _ á¶œâŸª Î³ âŸ«Ë¢)
        â‰¡âŸ¨ cong (Î± âˆ·_) subst-idá¶œâŸª Î³ âŸ«Ë¢ âŸ©
    Î± âˆ· Î³ âˆ
